---
# ------------------------------
title: "MARK 1 (beta)"               # Beta
# ------------------------------
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    logo: GDOTLogo.svg
    favicon: GDOTLogo.svg 
    css: style.css
    includes:
        in_header: google-analytics.html
    self_contained: FALSE
runtime: shiny
---

<style>

.table thead tr th:nth-child(2n+4) {
    /*color: white;*/
    visibility: hidden;
    font-size:1px;
    width:"50px";
}

.table thead tr th:nth-child(2) {
    width:"1000px";
}

</style>


```{r global, cache = FALSE, include = FALSE, warning = FALSE}
# FLEXDASHBOARD - RTOP_MONTHLY_REPORT

conf_mode <- "beta"

source("Monthly_Report_UI_Functions.R")


FIG_WIDTH = 14
FIG_HEIGHT = 7

AWS_BUCKET = "https://s3.amazonaws.com/gdot-spm"

```









Inputs {.sidebar}
=====================================

Measurement, Accuracy, and Reliability Kit (MARK 1) 

Past month reports can be viewed back to `r format(first_month, "%B %Y")`.


RTOP Concept of Operations can be found 
`r tags$a(href = "https://s3.amazonaws.com/gdot-spm/GDOT_STORM-COO.pdf", 
           target = "_blank",
           "here")`


```{r sidebar, warning = FALSE, cache = FALSE}
# shiny inputs defined here



selectInput("month", "Month:",
                       choices = month_options,
                       selected = month_options[1]) # Default to current month

selectInput("zone_group", "Signal Group:",
                       choices = zone_group_options,
                       selected = "All RTOP")



# Corridor Selection Drop Down based on Zone/Zone Group ---

conditionalPanel("input.zone_group != 'All RTOP'",
                 selectInput("corridor_x", "Corridor:",
                             choices = c("All Corridors"),
                             selected = "All Corridors"))

observe({
    choices_ <- if (is.null(input$zone_group)) {
                    NULL
                } else {
                    if (input$zone_group == "All RTOP") {
                        c("All Corridors")
                    } else if (input$zone_group %in% c("RTOP1", "RTOP2")) {
                        c("All Corridors",
                          as.character(unique(filter(
                              corridors, Zone_Group == input$zone_group)$Corridor)))
                    } else {
                        c("All Corridors",
                          as.character(unique(filter(
                              corridors, Zone == input$zone_group)$Corridor)))
                    }
                }
            
    updateSelectInput(session, "corridor_x", choices = sort(choices_), selected = "All Corridors")
})


# --- Sub-Corridor Selection Drop Down based on Corridor ---

conditionalPanel(
    "input.corridor_x != 'All Corridors'",
    radioButtons(
        "subcorridors", 
        label = NULL, 
        choices = c("By Intersection", "By Sub-corridor"), 
        selected = "By Intersection",
        inline = FALSE, 
        width = NULL, 
        choiceNames = NULL,
        choiceValues = NULL)
)


# --- -------------------------------------------------- ---


current_month <- reactive(lubridate::dmy(paste(1, input$month)))
endof_current_month <- reactive(lubridate::dmy(paste(1, input$month)) + months(1) - days(1))
current_quarter <- reactive(as.character(lubridate::quarter(current_month(), with_year = TRUE)))


# This is a simpler version of what is commented out below
corridor <- reactive({
    if (input$zone_group == "All RTOP") {
        "All Corridors"
    } else {
        input$corridor_x
    }
})


zone_group <- reactive(
    if (corridor() == "All Corridors") {
        input$zone_group
    } else {
        corridor()
    }
)


mr <- reactive(
    if (corridor() == "All Corridors") {
        cor
    } else if (input$subcorridors == "By Sub-corridor") {
        sub
    } else {
        sig
    }
)

filtered_corridors <- reactive({

    # All RTOP is the union of RTOP1, RTOP2
    if (input$zone_group == "All RTOP") {
        corr <- corridors %>% 
            filter(Zone_Group %in% c("RTOP1", "RTOP2"))

    # Zone 7 is the union of Zone 7m, 7d
    } else if (input$zone_group == "Zone 7") {
        corr <- corridors %>% 
            filter(grepl("^Zone 7", Zone))

    # Zones filter by Zone rather than Zone_Group
    } else if (startsWith(input$zone_group, "Zone")) {
        corr <- corridors %>% 
            filter(Zone %in% input$zone_group)

    } else {
        corr <- corridors %>% 
            filter(Zone_Group %in% input$zone_group)
    }
    
    # if a specific corridor is selected, filter on that
    if (corridor() != "All Corridors") {
        corr <- corr %>% 
            filter(Corridor == corridor())
    } 
    
    corr %>% select(-Description, -Asof)
})


filtered_signalids <- reactive({
    x <- filtered_corridors() %>% filter(as.integer(as.character(SignalID)) > 0)
    paste0(x$SignalID, ": ", x$Name)
})


mr_str <- reactive(
    if (corridor() == "All Corridors") {
        "cor"
    } else if (input$subcorridors == "By Sub-corridor") {
        "sub"
    } else {
        "sig"
    }
)

# renderText({"\nSelected Month"})
# renderPrint({current_month()})
# 
# renderText({"\nEnd of Selected Month"})
# renderPrint({endof_current_month()})
# 
# renderText({"Selected Querter"})
# renderPrint({current_quarter()})
# 


# renderText({"Selected Zone Group"})
# renderPrint({zone_group()})
# 
# renderText({"Selected Corridor"})
# renderPrint({corridor()})
# 
# renderText({"Sub-Corridors selected"})
# renderPrint({input$subcorridors})
# 
# renderText({"Filtered Corridors"})
# renderPrint({filtered_corridors()})
# 
# renderText({"mr()"})
# renderPrint({mr_str()})

# renderText({"env"})
# renderPrint({Sys.getenv("AWS_ACCESS_KEY_ID")})
# 
# renderText({"conf"})
# renderPrint({aws_conf$AWS_ACCESS_KEY_ID})


#renderText({"Mode:"})
#renderPrint({conf_mode})
#renderPrint({conf$mode})


# renderText({"\nSelected Month"})
# renderPrint({current_month()})
# 
# renderText({"Selected Zone Group"})
# renderPrint({zone_group()})
# 
# renderText({"Selected Corridor"})
# renderPrint({corridor()})
```









One-Month Summary
=====================================

Row {data-height = 50}
-------------------------------------

### Performance <a id = "page_performance"></a>

Arterial performance measures (% change from previous month)

Row
-------------------------------------

### Throughput [vph] {.value-box}

```{r}
renderValueBox({
    mr_mo_tp <- mr()$mo$tp
    zone_group_ <- zone_group()
    current_month_ <- current_month()
  
    
    future({
        valueBox(
            value = get_valuebox(
                mr_mo_tp, 
                "vph", 
                as_int, 
                zone = zone_group_, 
                mo = current_month_, 
                break_ = TRUE
            ),
            icon = "fa-bar-chart",
            color = BLUE
        )
    })
})
```

### Arrivals on Green {.value-box}

```{r}
renderValueBox({
    mr_mo_aogd <- mr()$mo$aogd
    zone_group_ <- zone_group()
    current_month_ <- current_month()
  
    future({
        valueBox(
            value = get_valuebox(
                mr_mo_aogd, 
                "aog", 
                as_pct, 
                zone = zone_group_, 
                mo = current_month_, 
                break_ = TRUE),
            icon = "fa-car",
            color = BLUE
        )
    })
})
```

### Progression Ratio {.value-box}

```{r}
renderValueBox({
  valueBox(
      value = get_valuebox(mr()$mo$prd, "pr", as_2dec, 
                           zone = zone_group(), mo = current_month(), break_ = TRUE),
      icon = "fa-car",
    color = BLUE
  )
})
```

### Spillback Rate {.value-box}

```{r}
renderValueBox({
  valueBox(
      value = get_valuebox(mr()$mo$qsd, "qs_freq", as_pct, 
                           zone = zone_group(), mo = current_month(), break_ = TRUE),
      icon = "fa-car",
    color = BLUE
  )
})
```

### Peak Period Split Failures {.value-box}

```{r}
renderValueBox({
  valueBox(
      value = get_valuebox(mr()$mo$sfd, "sf_freq", as_pct, 
                           zone = zone_group(), mo = current_month(), break_ = TRUE),
      icon = "fa-car",
    color = BLUE)
})
```

### Off-Peak Split Failures {.value-box}

```{r}
renderValueBox({
    valueBox(
        value = get_valuebox(
            mr()$mo$sfo, 
            "sf_freq", 
            as_pct, 
            zone = zone_group(), 
            mo = current_month(), 
            break_ = TRUE),
        icon = "fa-car",
    color = BLUE)
})
```

### Travel Time Index {.value-box}

```{r}
renderValueBox({
  valueBox(
      value = get_valuebox(cor$mo$tti, "tti", as_2dec, 
                           zone = zone_group(), mo = current_month(), break_ = TRUE),
      icon = "fa-dashboard",
    color = BLUE
  )
})
```

### Planning Time Index {.value-box}

```{r}
renderValueBox({
  valueBox(
      value = get_valuebox(cor$mo$pti, "pti", as_2dec, 
                           zone = zone_group(), mo = current_month(), break_ = TRUE),
      icon = "fa-dashboard",
    color = BLUE
  )
})
```


Row {data-height = 50}
-------------------------------------

### Volume-Based Measures

Corridor volumes (% change from previous month)

Row
-------------------------------------


### Traffic Volume [veh/day] {.value-box}

```{r}
renderValueBox({
  valueBox(
    value = get_valuebox(mr()$mo$vpd, "vpd", as_int, 
                           zone = zone_group(), mo = current_month(), break_ = FALSE),
    icon = "fa-area-chart",
    color = BLUE
  )
})
```

### AM Peak Volume [veh/hr] {.value-box}

```{r}
renderValueBox({
  valueBox(
      value = get_valuebox(mr()$mo$vphp$am, "vph", as_int, 
                           zone = zone_group(), mo = current_month(), break_ = FALSE),
      icon = "fa-area-chart",
    color = BLUE
  )
})
```

### PM Peak Volume [veh/hr] {.value-box}

```{r}
renderValueBox({
  valueBox(
      value = get_valuebox(mr()$mo$vphp$pm, "vph", as_int, 
                           zone = zone_group(), mo = current_month(), break_ = FALSE),
      icon = "fa-area-chart",
    color = BLUE
  )
})
```


### Pedestrian Activations [pa/day] {.value-box}

```{r}
renderValueBox({
    valueBox(
        value = get_valuebox(
            mr()$mo$papd, 
            "papd", as_int,
            zone = zone_group(),
            mo = current_month(),
            break_ = FALSE),
      icon = "fa-area-chart",
      color = BLUE
  )
})
```



```{r, eval = FALSE}
### {.value-box}
renderValueBox({
  valueBox(
    value = NULL,
    icon = NULL,
    color = "gray80"
  )
})
```

Row {data-height = 50}
-------------------------------------

### Equipment Measures

Device and Communications Uptime (% change from previous month)

Row
-------------------------------------

### Vehicle Detector Availability {.value-box}

```{r}
#cor$mo$veh
renderValueBox({
  valueBox(
      value = get_valuebox(mr()$mo$du, "uptime", as_pct, 
                           zone = zone_group(), mo = current_month(), break_ = TRUE),
      icon = "fa-car",
    color = BLUE
  )
})
```

### Pedestrian Detector Availability {.value-box}

```{r}
renderValueBox({
  valueBox(
      value = get_valuebox(mr()$mo$pau, "uptime", as_pct, 
                           zone = zone_group(), mo = current_month(), break_ = TRUE),
      icon = "fa-walking",
    color = BLUE
  )
})
```

### CCTV Availability {.value-box}

```{r}
renderValueBox({
  valueBox(
    value = get_valuebox(mr()$mo$cctv, "uptime", as_pct, 
                           zone = zone_group(), mo = current_month(), break_ = TRUE),
    icon = "glyphicon-facetime-video",
    color = BLUE
  )
})
```

### Communications Uptime {.value-box}

```{r}
renderValueBox({
  valueBox(
      value = get_valuebox(mr()$mo$cu, "uptime", as_pct, 
                           zone = zone_group(), mo = current_month(), break_ = TRUE),
      icon = "fa-broadcast-tower",
    color = BLUE
  )
})
```

### Roadside Unit (RSU) Uptime {.value-box}

```{r}
renderValueBox({
    valueBox(
        value = get_valuebox(
            mr()$mo$ru, 
            "uptime", 
            as_pct, 
            zone = zone_group(), 
            mo = current_month(), 
            break_ = TRUE),
        icon = "fa-wifi",  #"fa-user" #
    color = BLUE
    )
})
```


Row {data-height = 50}
-------------------------------------

### Activity Measures

Activity measures from TEAMS and as reported by Traffic Engineers (% change from previous month)

Row
-------------------------------------

### TEAMS Tasks Reported This Month {.value-box}

```{r}
renderValueBox({
  valueBox(
    value = get_valuebox(rename(cor$mo$tasks, delta = delta.rep), "Reported", as_int, 
                           zone = zone_group(), mo = current_month(), break_ = FALSE),
    icon = "fa-area-chart",
    color = BLUE
  )
})
```

### TEAMS Tasks Resolved This Month {.value-box}

```{r}
renderValueBox({
  valueBox(
    value = get_valuebox(rename(cor$mo$tasks, delta = delta.res), "Resolved", as_int, 
                           zone = zone_group(), mo = current_month(), break_ = FALSE),
    icon = "fa-area-chart",
    color = BLUE
  )
})
```

### TEAMS Tasks Outstanding [Unresolved] {.value-box}

```{r}
renderValueBox({
  valueBox(
    value = get_valuebox(rename(cor$mo$tasks, delta = delta.out), "Outstanding", as_int, 
                           zone = zone_group(), mo = current_month(), break_ = FALSE),
    icon = "fa-area-chart",
    color = BLUE
  )
})
```

### TEAMS Tasks Over 45 Days [Unresolved] {.value-box}

```{r}
renderValueBox({
  valueBox(
    value = get_valuebox(
        mr()$mo$over45, 
        "over45", as_int, 
        zone = zone_group(), 
        mo = current_month(), 
        break_ = FALSE),
    icon = "fa-area-chart",
    color = BLUE
  )
})
```

### TEAMS Tasks Mean Time to Resolve [Days] {.value-box}

```{r}
renderValueBox({
  valueBox(
    value = get_valuebox(
        mr()$mo$mttr, 
        "mttr", as_2dec, 
        zone = zone_group(), 
        mo = current_month(), 
        break_ = FALSE),
    icon = "fa-area-chart",
    color = BLUE
  )
})
```



```{r, eval = FALSE}
### {.value-box}
renderValueBox({
  valueBox(
    value = NULL,
    icon = NULL,
    color = "gray80"
  )
})
```









Quarter Summary
=====================================

Row {data-height = 50}
-------------------------------------

### Performance

Arterial performance measures (% change from previous quarter)

Row
-------------------------------------

### Throughput [vph] {.value-box}

```{r}
renderValueBox({
  valueBox(
      value = get_valuebox(cor$qu$tp, "vph", as_int, 
                           zone = zone_group(), 
                           mo = current_month(), 
                           qu = current_quarter(), break_ = TRUE),
      icon = "fa-bar-chart",
      color = GDOT_BLUE
  )
})
```

### Arrivals on Green {.value-box}

```{r}
renderValueBox({
  valueBox(
      value = get_valuebox(cor$qu$aogd, "aog", as_pct, 
                           zone = zone_group(), 
                           mo = current_month(), 
                           qu = current_quarter(), break_ = TRUE),
      icon = "fa-car",
      color = GDOT_BLUE_RGB
  )
})
```

### Progression Ratio {.value-box}

```{r}
renderValueBox({
  valueBox(
      value = get_valuebox(cor$qu$prd, "pr", as_2dec, 
                           zone = zone_group(), 
                           mo = current_month(), 
                           qu = current_quarter(), break_ = TRUE),
      icon = "fa-car",
      color = GDOT_BLUE
  )
})
```

### Spillback Rate {.value-box}

```{r}
renderValueBox({
  valueBox(
      value = get_valuebox(cor$qu$qsd, "qs_freq", as_pct, 
                           zone = zone_group(), 
                           mo = current_month(), 
                           qu = current_quarter(), break_ = TRUE),
      icon = "fa-car",
      color = GDOT_BLUE_RGB
  )
})
```

### Peak Period Split Failures {.value-box}

```{r}
renderValueBox({
  valueBox(
      value = get_valuebox(cor$qu$sfd, "sf_freq", as_pct, 
                           zone = zone_group(), 
                           mo = current_month(), 
                           qu = current_quarter(), break_ = TRUE),
      icon = "fa-car",
      color = GDOT_BLUE
  )
})
```

### Off-Peak Split Failures {.value-box}

```{r}
renderValueBox({
    valueBox(
        value = get_valuebox(
            cor$qu$sfo, 
            "sf_freq", 
            as_pct, 
            zone = zone_group(), 
            mo = current_month(), 
            qu = current_quarter(), 
            break_ = TRUE),
      icon = "fa-car",
      color = GDOT_BLUE_RGB)
})
```

### Travel Time Index {.value-box}

```{r}
renderValueBox({
  valueBox(
      value = get_valuebox(cor$qu$tti, "tti", as_2dec, 
                           zone = zone_group(), 
                           mo = current_month(), 
                           qu = current_quarter(), break_ = TRUE),
      icon = "fa-dashboard",
      color = GDOT_BLUE
  )
})
```

### Planning Time Index {.value-box}

```{r}
renderValueBox({
  valueBox(
      value = get_valuebox(cor$qu$pti, "pti", as_2dec, 
                           zone = zone_group(), 
                           mo = current_month(), 
                           qu = current_quarter(), break_ = TRUE),
      icon = "fa-dashboard",
      color = GDOT_BLUE_RGB
  )
})
```


Row {data-height = 50}
-------------------------------------

### Volume-Based Measures

Corridor volumes (% change from previous quarter)

Row
-------------------------------------


### Traffic Volume [veh/day] {.value-box}

```{r}
renderValueBox({
  valueBox(
    value = get_valuebox(cor$qu$vpd, "vpd", as_int, 
                           zone = zone_group(), 
                           mo = current_month(), 
                           qu = current_quarter(), break_ = FALSE),
    icon = "fa-area-chart",
      color = GDOT_YELLOW_RGB
  )
})
```

### AM Peak Volume [veh/hr] {.value-box}

```{r}
renderValueBox({
  valueBox(
      value = get_valuebox(cor$qu$vphpa, "vph", as_int, 
                           zone = zone_group(), 
                           mo = current_month(),
                           qu = current_quarter(), break_ = FALSE),
      icon = "fa-area-chart",
      color = GDOT_YELLOW
  )
})
```

### PM Peak Volume [veh/hr] {.value-box}

```{r}
renderValueBox({
  valueBox(
      value = get_valuebox(cor$qu$vphpp, "vph", as_int, 
                         zone = zone_group(), 
                         mo = current_month(), 
                         qu = current_quarter(), break_ = FALSE),
      icon = "fa-area-chart",
      color = GDOT_YELLOW_RGB
  )
})
```


### Pedestrian Activations [pa/day] {.value-box}

```{r}
renderValueBox({
    valueBox(
        value = get_valuebox(
            cor$qu$papd, 
            "papd", as_int,
            zone = zone_group(),
            mo = current_month(),
            qu = current_quarter(), 
            break_ = FALSE),
      icon = "fa-area-chart",
      color = GDOT_YELLOW
  )
})
```



```{r, eval = FALSE}
### {.value-box}
renderValueBox({
  valueBox(
    value = NULL,
    icon = NULL,
    color = "gray80"
  )
})
```

Row {data-height = 50}
-------------------------------------

### Equipment Measures

Device and Communications Uptime (% change from previous quarter)

Row
-------------------------------------

### Vehicle Detector Availability {.value-box}

```{r}
#cor$qu$veh
renderValueBox({
  valueBox(
      value = get_valuebox(cor$qu$du, "uptime", as_pct, 
                         zone = zone_group(), 
                         mo = current_month(), 
                         qu = current_quarter(), break_ = TRUE),
      icon = "fa-car",
      color = GDOT_BLUE
  )
})
```

### Pedestrian Detector Availability {.value-box}

```{r}

renderValueBox({
  valueBox(
    value = get_valuebox(cor$qu$pau, "uptime", as_pct, 
                         zone = zone_group(), 
                         mo = current_month(), 
                         qu = current_quarter(), break_ = TRUE),
    icon = "fa-walking",
      color = GDOT_BLUE_RGB
  )
})
```

### CCTV Availability {.value-box}

```{r}
renderValueBox({
  valueBox(
    value = get_valuebox(cor$qu$cctv, "uptime", as_pct, 
                         zone = zone_group(), 
                         mo = current_month(), 
                         qu = current_quarter(), break_ = TRUE),
    icon = "glyphicon-facetime-video",
      color = GDOT_BLUE 
  )
})
```

### Communications Uptime {.value-box}

```{r}
renderValueBox({
  valueBox(
      value = get_valuebox(cor$qu$cu, "uptime", as_pct, 
                         zone = zone_group(), 
                         mo = current_month(), 
                         qu = current_quarter(), break_ = TRUE),
      icon = "fa-broadcast-tower",
      color = GDOT_BLUE_RGB
  )
})
```

### Roadside Unit (RSU) Uptime {.value-box}

```{r}
renderValueBox({
    valueBox(
        value = get_valuebox(
            cor$qu$ru, 
            "uptime", 
            as_pct, 
            zone = zone_group(), 
            mo = current_month(), 
            qu = current_quarter(), 
            break_ = TRUE),
        icon = "fa-wifi",
        color = GDOT_BLUE
    )
})
```


Row {data-height = 50}
-------------------------------------

### Activity Measures

Activity measures from TEAMS and as reported by Traffic Engineers (% change from previous quarter)

Row
-------------------------------------

### TEAMS Tasks Reported This Quarter {.value-box}

```{r}
renderValueBox({
  valueBox(
      value = get_valuebox(cor$qu$reported, "Reported", as_int, 
                         zone = zone_group(), 
                         mo = current_month(), 
                         qu = current_quarter(), break_ = FALSE),
      icon = "fa-area-chart",
      color = GDOT_YELLOW
  )
})
```

### TEAMS Tasks Resolved This Quarter {.value-box}

```{r}
renderValueBox({
  valueBox(
    value = get_valuebox(cor$qu$resolved, "Resolved", as_int, 
                         zone = zone_group(), 
                         mo = current_month(), 
                         qu = current_quarter(), break_ = FALSE),
    icon = "fa-area-chart",
      color = GDOT_YELLOW_RGB
  )
})
```

### TEAMS Tasks Outstanding [Unresolved] {.value-box}

```{r}
renderValueBox({
  valueBox(
    value = get_valuebox(cor$qu$outstanding, "Outstanding", as_int, 
                         zone = zone_group(), 
                         mo = current_month(), 
                         qu = current_quarter(), break_ = FALSE),
    icon = "fa-area-chart",
      color = GDOT_YELLOW
  )
})
```

### TEAMS Tasks Over 45 Days [Unresolved] {.value-box}

```{r}
renderValueBox({
  valueBox(
    value = get_valuebox(
        cor$qu$over45,
        "over45", as_int,
        zone = zone_group(), 
        mo = current_month(), 
        qu = current_quarter(),
        break_ = FALSE),
    icon = "fa-area-chart",
    color = GDOT_YELLOW_RGB
  )
})
```

### TEAMS Tasks Mean Time to Resolve [Days] {.value-box}

```{r}
renderValueBox({
  valueBox(
    value = get_valuebox(
        cor$qu$mttr, 
        "mttr", as_2dec, 
        zone = zone_group(), 
        mo = current_month(), 
        qu = current_quarter(),
        break_ = FALSE),
    icon = "fa-area-chart",
    color = GDOT_YELLOW
  )
})
```


```{r, eval = FALSE}
### {.value-box}
renderValueBox({
  valueBox(
    value = NULL,
    icon = NULL,
    color = "gray80"
  )
})
```









Summary Trend
=====================================

Row
-------------------------------------

### Performance

```{r summary_left_refactored, eval = TRUE, warning = FALSE}

styl <- "font-family: Source Sans Pro; font-size: 14px; padding-top: 25px"

shinyApp(

    ui = fillPage(
        fillCol(
            fillRow(
                       div("Throughput", style = styl),
                       plotlyOutput("tp_trend", height = 100, width = "100%"),
                       flex = c(1.5, 11.5)
            ),
            fillRow(
                       div("Arrivals on Green", style = styl),
                       plotlyOutput("aog_trend", height = 100, width = "100%"),
                       flex = c(1.5, 11.5)
            ),
            fillRow(
                       div("Progression Ratio", style = styl),
                       plotlyOutput("pr_trend", height = 100, width = "100%"),
                       flex = c(1.5, 11.5)
            ),
            fillRow(
                       div("Queue Spillback", style = styl),
                       plotlyOutput("qs_trend", height = 100, width = "100%"),
                       flex = c(1.5, 11.5)
            ),
            fillRow(
                       div("Split Failures", style = styl),
                       plotlyOutput("sf_trend", height = 100, width = "100%"),
                       flex = c(1.5, 11.5)
            ),
            fillRow(
                       div("Off-Peak Split Failures", style = styl),
                       plotlyOutput("sfo_trend", height = 100, width = "100%"),
                       flex = c(1.5, 11.5)
            ),
            fillRow(
                       div("Travel Time Index", style = styl),
                       plotlyOutput("tti_trend", height = 100, width = "100%"),
                       flex = c(1.5, 11.5)
            ),
            fillRow(
                       div("Planning Time Index", style = styl),
                       plotlyOutput("pti_trend", height = 100, width = "100%"),
                       flex = c(1.5, 11.5)
            )
      )
    ),
    
    server = function(input, output, session) {
      
        output$tp_trend <- renderPlotly({
          
            perf_plots$tp_trend # plot_ly object, saved from calcs
          
            # data.set <- filter(cor$mo$tp, Corridor=="All RTOP" & Month <= report_months[1])
            # shiny::validate(need(nrow(data.set) > 0, "No Data"))
            # perf_plot_beta(data.set, "vph", "Throughput", RED2, 
            #                format_func = as_int)
        })
        
        output$aog_trend <- renderPlotly({
            data.set <- filter(cor$mo$aogd, Corridor=="All RTOP" & Month <= report_months[1])
            shiny::validate(need(nrow(data.set) > 0, "No Data"))
            perf_plot_beta(data.set, "aog", "Arrivals on Green\nGoal: 80%", RED2,
                           format_func = as_pct, hoverformat = ".1%")
        })
        output$pr_trend <- renderPlotly({
            data.set <- filter(cor$mo$prd, Corridor=="All RTOP" & Month <= report_months[1])
            shiny::validate(need(nrow(data.set) > 0, "No Data"))
            perf_plot_beta(data.set, "pr", "Progression Ratio\nGoal: 1.2", RED2,
                           format_func = as_2dec, hoverformat = ".2f")
        })
        output$qs_trend <- renderPlotly({
            data.set <- filter(cor$mo$qsd, Corridor=="All RTOP" & Month <= report_months[1])
            shiny::validate(need(nrow(data.set) > 0, "No Data"))
            perf_plot_beta(data.set, "qs_freq", "Queue\nSpillback", RED2,
                       format_func = as_pct, hoverformat = ".1%")
        })
        output$sf_trend <- renderPlotly({
            data.set <- filter(cor$mo$sfd, Corridor=="All RTOP" & Month <= report_months[1])
            shiny::validate(need(nrow(data.set) > 0, "No Data"))
            perf_plot_beta(data.set, "sf_freq", "Peak\nSplit Failure", RED2,
                       format_func = as_pct, hoverformat = ".1%")
        })
        output$sfo_trend <- renderPlotly({
            data.set <- filter(cor$mo$sfo, Corridor=="All RTOP" & Month <= report_months[1])
            shiny::validate(need(nrow(data.set) > 0, "No Data"))
            perf_plot_beta(data.set, "sf_freq", "Off-Peak\nSplit Failure", RED2,
                       format_func = as_pct, hoverformat = ".1%")
        })
        output$tti_trend <- renderPlotly({
            data.set <- filter(cor$mo$tti, Corridor=="All RTOP" & Month <= report_months[1])
            shiny::validate(need(nrow(data.set) > 0, "No Data"))
            perf_plot_beta(data.set, "tti", "Travel Time\nIndex", RED2,
                       format_func = as_2dec, hoverformat = ".2f")
        })
        output$pti_trend <- renderPlotly({
            data.set <- filter(cor$mo$pti, Corridor=="All RTOP" & Month <= report_months[1])
            shiny::validate(need(nrow(data.set) > 0, "No Data"))
            perf_plot_beta(data.set, "pti", "Planning Time\nIndex", RED2,
                       format_func = as_2dec, hoverformat = ".2f")        
        })
        
        observe({
          
            mr_ <- mr()
      
            for (plot_name in c("tp_trend", "aog_trend", "pr_trend", "qs_trend",
                                "sf_trend", "sfo_trend",  "tti_trend", "pti_trend")) {
                # Remove existing traces
                plotlyProxy(plot_name, session) %>%
                    plotlyProxyInvoke("deleteTraces", list(as.integer(0))) %>%
                    plotlyProxyInvoke("deleteTraces", list(as.integer(0))) %>%
                    plotlyProxyInvoke("deleteTraces", list(as.integer(0))) %>%
                    plotlyProxyInvoke("deleteTraces", list(as.integer(0)))
                
            }
          
            ### Throughput ##
            updated <- get_perf_plot_updates(
                mr_$mo$tp, "vph", "Throughput", RED2, 
                format_func = as_int,
                hoverformat = ".1%",
                zone_group(), current_month())

            plotlyProxy("tp_trend", session) %>%
                plotlyProxyInvoke("addTraces", updated$traces) %>%
                plotlyProxyInvoke("relayout", updated$layouts)
            
            
            
            ### Arrivals on Green ##
            updated <- get_perf_plot_updates(
                mr_$mo$aogd, "aog", "Arrivals On Green", RED2, 
                format_func = as_pct,
                hoverformat = ".1%",
                zone_group(), current_month())

            plotlyProxy("aog_trend", session) %>%
                plotlyProxyInvoke("addTraces", updated$traces) %>%
                plotlyProxyInvoke("relayout", updated$layouts)
            
            
            
            ### Progression Ratio ##
            updated <- get_perf_plot_updates(
                mr_$mo$prd, "pr", "Progression Ratio", RED2, 
                format_func = as_2dec,
                hoverformat = ".2f",
                zone_group(), current_month())

            plotlyProxy("pr_trend", session) %>%
                plotlyProxyInvoke("addTraces", updated$traces) %>%
                plotlyProxyInvoke("relayout", updated$layouts)

            
            
            ### Queue Spillback ##
            updated <- get_perf_plot_updates(
                mr_$mo$qsd, "qs_freq", "", RED2, 
                format_func = as_pct,
                hoverformat = ".1%",
                zone_group(), current_month())

            plotlyProxy("qs_trend", session) %>%
                plotlyProxyInvoke("addTraces", updated$traces) %>%
                plotlyProxyInvoke("relayout", updated$layouts)

            
            
            
            ## Peak Period Split Failures ##
            updated <- get_perf_plot_updates(
                mr_$mo$sfd, "sf_freq", "", RED2,
                format_func = as_pct,
                hoverformat = ".1%",
                zone_group(), current_month())

            plotlyProxy("sf_trend", session) %>%
                plotlyProxyInvoke("addTraces", updated$traces) %>%
                plotlyProxyInvoke("relayout", updated$layouts)

            
            
            
            ## Off-Peak Split Failures ##
            updated <- get_perf_plot_updates(
                mr_$mo$sfo, "sf_freq", "", RED2,
                format_func = as_pct,
                hoverformat = ".1%",
                zone_group(), current_month())

            plotlyProxy("sfo_trend", session) %>%
                plotlyProxyInvoke("addTraces", updated$traces) %>%
                plotlyProxyInvoke("relayout", updated$layouts)




            ### Travel Time Index ##
            updated <- get_perf_plot_updates(
                mr_$mo$tti, "tti", "", RED2,
                format_func = as_2dec,
                hoverformat = ".2f",
                zone_group(), current_month())

            plotlyProxy("tti_trend", session) %>%
                plotlyProxyInvoke("addTraces", updated$traces) %>%
                plotlyProxyInvoke("relayout", updated$layouts)




            ### Arrivals on Green ##
            updated <- get_perf_plot_updates(
                mr_$mo$pti, "pti", "", RED2,
                format_func = as_2dec,
                hoverformat = ".2f",
                zone_group(), current_month())

            plotlyProxy("pti_trend", session) %>%
                plotlyProxyInvoke("addTraces", updated$traces) %>%
                plotlyProxyInvoke("relayout", updated$layouts)

        })
    },
    
    options = list(height = 800)
)
```

```{r summary_left, eval = FALSE, warning = FALSE}

fillCol(
    renderPlotly({ 
        data.set <- filter(mr()$mo$tp, Corridor==zone_group() & Month <= current_month())
        shiny::validate(need(nrow(data.set) > 0, "No Data"))
        goal_ <- NULL
        future({
        perf_plot_beta(
            data.set, "vph", "Throughput", RED2, format_func = as_int)
        })
    }),
    renderPlotly({ 
        data.set <- filter(mr()$mo$aogd, Corridor==zone_group() & Month <= current_month())
        shiny::validate(need(nrow(data.set) > 0, "No Data"))
        goal_ <- goal$aogd
        future({
        perf_plot_beta(
            data.set, "aog", "Arrivals on Green\nGoal: 80%", RED2, 
            format_func = as_pct, 
            hoverformat = ".1%",
            fill_color_ = LIGHT_RED, 
            goal_ = goal_)
        })
    }),
    renderPlotly({ 
        data.set <- filter(mr()$mo$prd, Corridor==zone_group() & Month <= current_month())
        shiny::validate(need(nrow(data.set) > 0, "No Data"))
        goal_ <- goal$prd
        future({
        perf_plot_beta(
            data.set, "pr", "Progression Ratio\nGoal: 1.2", RED2, 
            format_func = as_2dec, 
            hoverformat = ".2f", 
            fill_color_ = LIGHT_RED, 
            goal_ = goal_)
        })
    }),
    renderPlotly({ 
        data.set <- filter(mr()$mo$qsd, Corridor==zone_group() & Month <= current_month())
        shiny::validate(need(nrow(data.set) > 0, "No Data"))
        goal_ <- goal$qsd
        future({
        perf_plot_beta(
            data.set, "qs_freq", "Queue\nSpillback", RED2, 
            format_func = as_pct, 
            hoverformat = ".1%", 
            fill_color_ = LIGHT_RED, 
            goal_ = goal_)
        })
    }),
    renderPlotly({ 
        data.set <- filter(mr()$mo$sfd, Corridor==zone_group() & Month <= current_month())
        shiny::validate(need(nrow(data.set) > 0, "No Data"))
        goal_ <- goal$sfd
        future({
        perf_plot_beta(data.set, "sf_freq", "Peak\nSplit Failure", RED2, 
                   format_func = as_pct, 
                   hoverformat = ".1%", 
                       fill_color_ = LIGHT_RED, 
                       goal_ = goal_)
        })
    }),
    ##----------------
    renderPlotly({ 
        data.set <- filter(
            mr()$mo$sfo, 
            Corridor==zone_group() & Month <= current_month()
        )
        shiny::validate(need(nrow(data.set) > 0, "No Data"))
        goal_ <- goal$sfd
        future({
        perf_plot_beta(
            data.set, 
            "sf_freq", 
            "Off-Peak\nSplit Failure", 
            RED2,
            format_func = as_pct, 
            hoverformat = ".1%", 
            fill_color_ = LIGHT_RED, 
            goal_ = goal_
        )
        })
    }),
    ##----------------
    renderPlotly({ 
        data.set <- filter(cor$mo$tti, Corridor==zone_group() & Month <= current_month())
        shiny::validate(need(nrow(data.set) > 0, "No Data"))
        goal_ <- goal$tti
        future({
        perf_plot_beta(data.set, "tti", "Travel Time\nIndex", RED2, 
                   format_func = as_2dec, 
                   hoverformat = ".2f", 
                       fill_color_ = LIGHT_RED, 
                       goal_ = goal_) 
        })
    }),
    renderPlotly({ 
        data.set <- filter(cor$mo$pti, Corridor==zone_group() & Month <= current_month())
        shiny::validate(need(nrow(data.set) > 0, "No Data"))
        goal_ <- goal$pti
        future({
        perf_plot_beta(data.set, "pti", "Planning Time\nIndex", RED2, 
                   format_func = as_2dec, 
                   hoverformat = ".2f", 
                       fill_color_ = LIGHT_RED, 
                       goal_ = goal_)
        })
    }),
    height = 800
)
```

### Volumes and Equipment

```{r summary_right, eval = FALSE, warning = FALSE} 

fillCol(
    renderPlotly({ 
        data.set <- filter(mr()$mo$vpd, Corridor==zone_group() & Month <= current_month())
        shiny::validate(need(nrow(data.set) > 0, "No Data"))
        future({
        perf_plot_beta(data.set, "vpd", "Daily\nVolume", GDOT_BLUE, 
                   format_func = as_int)
        })
    }),
    
    renderPlotly({ 
        data.set <- filter(mr()$mo$vphp$am, Corridor==zone_group() & Month <= current_month())
        shiny::validate(need(nrow(data.set) > 0, "No Data"))
        future({
          perf_plot_beta(data.set, "vph", "AM Hourly\nVolume", GDOT_BLUE, 
                   format_func = as_int)
        })
    }),
    renderPlotly({ 
        data.set <- filter(mr()$mo$vphp$pm, Corridor==zone_group() & Month <= current_month())
        shiny::validate(need(nrow(data.set) > 0, "No Data"))
        future({
        perf_plot_beta(data.set, "vph", "PM Hourly\nVolume", GDOT_BLUE, 
                   format_func = as_int)
        })
    }),

    renderPlotly({ 
        data.set <- filter(mr()$mo$du, Corridor==zone_group() & Month <= current_month())
        shiny::validate(need(nrow(data.set) > 0, "No Data"))
        future({
        perf_plot_beta(data.set, "uptime", "Detector\nUptime\nGoal: 95%", ORANGE, 
                   format_func = as_pct, 
                   hoverformat = ".1%", 
                       fill_color_ = LIGHT_ORANGE, 
                       goal_ = goal$du)
        })
    }),
    renderPlotly({ 
        data.set <- filter(cor$mo$pau, 
                          Corridor==zone_group() & Month <= current_month())
        shiny::validate(need(nrow(data.set) > 0, "No Data"))
        future({
        perf_plot_beta(data.set, "uptime", "Ped Detector\nUptime\nGoal: 95%", ORANGE, 
                   format_func = as_pct, 
                   hoverformat = ".1%", 
                       fill_color_ = LIGHT_ORANGE, 
                       goal_ = goal$pau)
        })
    }),
    renderPlotly({ 
        data.set <- filter(mr()$mo$cctv, 
                          Corridor==zone_group() & Month <= current_month())
        shiny::validate(need(nrow(data.set) > 0, "No Data"))
        future({
        perf_plot_beta(data.set, "uptime", "CCTV\nUptime\nGoal: 95%", ORANGE, 
                   format_func = as_pct, 
                   hoverformat = ".1%", 
                       fill_color_ = LIGHT_ORANGE, 
                       goal_ = goal$cctv)
        })
    }),
    renderPlotly({ 
        data.set <- filter(mr()$mo$cu, Corridor==zone_group() & Month <= current_month())
        shiny::validate(need(nrow(data.set) > 0, "No Data"))
        perf_plot_beta(data.set, "uptime", "Communications\nUptime\nGoal: 95%", ORANGE, 
                   format_func = as_pct, 
                   hoverformat = ".1%", 
                       fill_color_ = LIGHT_ORANGE, 
                       goal_ = goal$cu)
    }),
    renderPlotly({ 
        data.set <- filter(mr()$mo$ru, Corridor==zone_group() & Month <= current_month())
        shiny::validate(need(nrow(data.set) > 0, "No Data"))
        future({
        perf_plot_beta(
            data.set, 
            "uptime", 
            "Roadside Unit (RSU)\nUptime\nGoal: 95%", 
            ORANGE, 
            format_func = as_pct, 
            hoverformat = ".1%",
            fill_color_ = LIGHT_ORANGE,
            goal_ = goal$cu)
        })
    }),renderPlotly({ 
        data.set <- filter(mr()$mo$pau, Corridor==zone_group() & Month <= current_month())
        shiny::validate(need(nrow(data.set) > 0, "No Data"))
        future({
        perf_plot_beta(data.set, "uptime", "Ped Detector\nUptime\nGoal: 95%", ORANGE, 
                   format_func = as_pct, 
                   hoverformat = ".1%", 
                       fill_color_ = LIGHT_ORANGE, 
                       goal_ = goal$pau)
        })
    }),
    height = 800
)
```

```{r summary_right_refactored, eval = TRUE, warning = FALSE}

styl <- "font-family: Source Sans Pro; font-size: 14px; padding-top: 25px"

shinyApp(

    ui = fillPage(
        fillCol(
            fillRow(
                       div("Vehicles per Day", style = styl),
                       plotlyOutput("vpd_trend", height = 100, width = "100%"),
                       flex = c(1.5, 11.5)
            ),
            fillRow(
                       div("Vehicles per Hour (AM)", style = styl),
                       plotlyOutput("vpha_trend", height = 100, width = "100%"),
                       flex = c(1.5, 11.5)
            ),
            fillRow(
                       div("Vehicles per Hour (PM)", style = styl),
                       plotlyOutput("vphp_trend", height = 100, width = "100%"),
                       flex = c(1.5, 11.5)
            ),
            fillRow(
                       div("Detector Uptime", style = styl),
                       plotlyOutput("du_trend", height = 100, width = "100%"),
                       flex = c(1.5, 11.5)
            ),
            fillRow(
                       div("Ped Button Uptime", style = styl),
                       plotlyOutput("pau_trend", height = 100, width = "100%"),
                       flex = c(1.5, 11.5)
            ),
            fillRow(
                       div("CCTV Uptime", style = styl),
                       plotlyOutput("cctv_trend", height = 100, width = "100%"),
                       flex = c(1.5, 11.5)
            ),
            fillRow(
                       div("Comm Uptime", style = styl),
                       plotlyOutput("cu_trend", height = 100, width = "100%"),
                       flex = c(1.5, 11.5)
            ),
            fillRow(
                       div("RSU Uptime", style = styl),
                       plotlyOutput("ru_trend", height = 100, width = "100%"),
                       flex = c(1.5, 11.5)
            )
      )
    ),
    
    server = function(input, output, session) {
    
        output$vpd_trend <- renderPlotly({
            perf_plots$vpd_trend
        })
        output$vpha_trend <- renderPlotly({
            perf_plots$vpha_trend
        })
        output$vphp_trend <- renderPlotly({
            perf_plots$vphp_trend
        })
        output$du_trend <- renderPlotly({
            perf_plots$du_trend
        })
        output$pau_trend <- renderPlotly({
            perf_plots$pau_trend
        })
        output$cctv_trend <- renderPlotly({
            perf_plots$cctv_trend
        })
        output$cu_trend <- renderPlotly({
            perf_plots$cu_trend
        })
        output$ru_trend <- renderPlotly({
            perf_plots$ru_trend
        })
        
        observe({
        
            mr_ <- mr()

            for (plot_name in c("vpd_trend", "vpha_trend", "vphp_trend", 
                                "du_trend", "pau_trend", "cctv_trend",  "cu_trend", "ru_trend")) {
                # Remove existing traces
                plotlyProxy(plot_name, session) %>%
                    plotlyProxyInvoke("deleteTraces", list(as.integer(0))) %>%
                    plotlyProxyInvoke("deleteTraces", list(as.integer(0))) %>%
                    plotlyProxyInvoke("deleteTraces", list(as.integer(0))) %>%
                    plotlyProxyInvoke("deleteTraces", list(as.integer(0)))
                
            }
          
            ### Vehicles per Day ##
            updated <- get_perf_plot_updates(
                mr_$mo$vpd, "vpd", "", GDOT_BLUE,
                format_func = as_int,
                hoverformat_ = ",.0f",
                zone_group(), current_month())

            plotlyProxy("vpd_trend", session) %>%
                plotlyProxyInvoke("addTraces", updated$traces) %>%
                plotlyProxyInvoke("relayout", updated$layouts)
            
            
            
            ### Peak Period Vehicles per Hour (AM) ##
            updated <- get_perf_plot_updates(
                mr_$mo$vphp$am, "vph", "", GDOT_BLUE,
                format_func = as_int,
                hoverformat_ = ",.0f",
                zone_group(), current_month())

            plotlyProxy("vpha_trend", session) %>%
                plotlyProxyInvoke("addTraces", updated$traces) %>%
                plotlyProxyInvoke("relayout", updated$layouts)
            
            
            
            ### Peak Period Vehicles per Hour (PM) ##
            updated <- get_perf_plot_updates(
                mr_$mo$vphp$pm, "vph", "", GDOT_BLUE,
                format_func = as_int,
                hoverformat_ = ",.0f",
                zone_group(), current_month())

            plotlyProxy("vphp_trend", session) %>%
                plotlyProxyInvoke("addTraces", updated$traces) %>%
                plotlyProxyInvoke("relayout", updated$layouts)

            
            
            ## Detector Uptime ##
            updated <- get_perf_plot_updates(
                mr_$mo$du, "uptime", "", ORANGE,
                format_func = as_pct, 
                hoverformat = ".1%",
                zone_group(), current_month())

            plotlyProxy("du_trend", session) %>%
                plotlyProxyInvoke("addTraces", updated$traces) %>%
                plotlyProxyInvoke("relayout", updated$layouts)

            
            
            
            ## Ped Pushbutton Uptime ##
            updated <- get_perf_plot_updates(
                mr_$mo$pau, "uptime", "", ORANGE,
                format_func = as_pct, 
                hoverformat = ".1%",
                zone_group(), current_month())

            plotlyProxy("pau_trend", session) %>%
                plotlyProxyInvoke("addTraces", updated$traces) %>%
                plotlyProxyInvoke("relayout", updated$layouts)




            ### CCTV Uptime ##
            updated <- get_perf_plot_updates(
                mr_$mo$cctv, "uptime", "", ORANGE,
                format_func = as_pct, 
                hoverformat = ".1%",
                zone_group(), current_month())

            plotlyProxy("cctv_trend", session) %>%
                plotlyProxyInvoke("addTraces", updated$traces) %>%
                plotlyProxyInvoke("relayout", updated$layouts)




            ### Communications Uptime ##
            updated <- get_perf_plot_updates(
                mr_$mo$cu, "uptime", "", ORANGE,
                format_func = as_pct, 
                hoverformat = ".1%",
                zone_group(), current_month())

            plotlyProxy("cu_trend", session) %>%
                plotlyProxyInvoke("addTraces", updated$traces) %>%
                plotlyProxyInvoke("relayout", updated$layouts)

                
            
            
            ### RSU Uptime ##
            updated <- get_perf_plot_updates(
                mr_$mo$ru, "uptime", "", ORANGE,
                format_func = as_pct, 
                hoverformat = ".1%",
                zone_group(), current_month())

            plotlyProxy("ru_trend", session) %>%
                plotlyProxyInvoke("addTraces", updated$traces) %>%
                plotlyProxyInvoke("relayout", updated$layouts)

        })
    },
    
    options = list(height = 800)
)
```








Performance
=====================================

Row
-------------------------------------

### Throughput (vph) {.value-box}

```{r, warning = FALSE}
renderValueBox({
  valueBox(
      value = get_valuebox(mr()$mo$tp, "vph", as_int,
                           zone = zone_group(), mo = current_month(), break_ = TRUE),
      icon = "fa-bar-chart"
  )
})
```

### Arrivals on Green {.value-box}

```{r, warning = FALSE}
renderValueBox({
  valueBox(
      value = get_valuebox(mr()$mo$aogd, "aog", as_pct,
                           zone = zone_group(), mo = current_month(), break_ = TRUE),
      icon = "fa-car"
  )
})
```

### Progression Ratio {.value-box}

```{r, warning = FALSE}
renderValueBox({
  valueBox(
      value = get_valuebox(mr()$mo$prd, "pr", as_2dec,
                           zone = zone_group(), mo = current_month(), break_ = TRUE),
      icon = "fa-car"
  )
})
```

### Spillback Rate {.value-box}

```{r, warning = FALSE}
renderValueBox({
  valueBox(
      value = get_valuebox(mr()$mo$qsd, "qs_freq", as_pct,
                           zone = zone_group(), mo = current_month(), break_ = TRUE),
      icon = "fa-car"
  )
})
```

### Peak Period Split Failures {.value-box}

```{r}
renderValueBox({
    valueBox(
        value = get_valuebox(
            mr()$mo$sfd, 
            "sf_freq", 
            as_pct,
            zone = zone_group(), 
            mo = current_month(), 
            break_ = TRUE),
      icon = "fa-car"
  )
})
```

### Off-Peak Split Failures {.value-box}

```{r}
renderValueBox({
    valueBox(
        value = get_valuebox(
            mr()$mo$sfo, 
            "sf_freq", 
            as_pct,
            zone = zone_group(), 
            mo = current_month(), 
            break_ = TRUE),
      icon = "fa-car")
})
```

### Travel Time Index {.value-box}

```{r, warning = FALSE}
renderValueBox({
  valueBox(
      value = get_valuebox(cor$mo$tti, "tti", as_2dec,
                           zone = zone_group(), mo = current_month(), break_ = TRUE),
      icon = "fa-dashboard"
  )
})
```

### Planning Time Index {.value-box}

```{r, warning = FALSE}
renderValueBox({
  valueBox(
      value = get_valuebox(cor$mo$pti, "pti", as_2dec,
                           zone = zone_group(), mo = current_month(), break_ = TRUE),
      icon = "fa-dashboard"
  )
})
```


Row {.tabset .tabset-fade}
-------------------------------------


### Throughput

```{r, fig.width = FIG_WIDTH, fig.height = FIG_HEIGHT, warning = FALSE}
renderPlotly({
  
    mr_wk_tp <- mr()$wk$tp
    mr_mo_tp <- mr()$mo$tp 
    current_month_ <- current_month()
    zone_group_ <- zone_group()
    input_month <- input$month
    
    future({
    get_bar_line_dashboard_plot(
        mr_wk_tp, 
        mr_mo_tp, 
        NULL,
        "vph", 
        "integer", 
        highlight_color = RED2,
        month_ = current_month_, 
        zone_group_ = zone_group_,
        x_bar_title = paste(input_month, "Throughput (vph)"),
        x_line1_title = "Vehicles per Hour Trend",
        plot_title = "Throughput (peak veh/hr)")
    })
})
```


### Arrivals on Green

```{r, fig.width = FIG_WIDTH, fig.height = FIG_HEIGHT, warning = FALSE}

renderPlotly({
  
    mr_wk_aog <- mr()$wk$aog
    mr_mo_aogd <- mr()$mo$aogd
    mr_mo_aogh <- mr()$mo$aogh
    current_month_ <- current_month()
    zone_group_ <- zone_group()
    input_month <- input$month
    
    future({
    get_bar_line_dashboard_plot(
        mr_wk_aog, 
        mr_mo_aogd, 
        mr_mo_aogh,
        "aog", "percent", highlight_color = RED2,
        month_ = current_month_, 
        zone_group_ = zone_group_,
        x_bar_title = paste(input_month, "AOG"),
        x_line1_title = "AOG Trend",
        x_line2_title = paste(input_month, "AOG by TOD"),
        plot_title = "Percent Arrivals on Green")
})
})
```


### Progression Ratio

```{r, fig.width = FIG_WIDTH, fig.height = FIG_HEIGHT, warning = FALSE}
rmarkdown::render_delayed({
renderPlotly({
    get_bar_line_dashboard_plot(
        mr()$wk$pr, 
        mr()$mo$prd, 
        mr()$mo$prh,
        "pr", "decimal", highlight_color = RED2,
        month_ = current_month(), 
        zone_group_ = zone_group(),
        x_bar_title = paste(input$month, "AOG"),
        x_line1_title = "Progression Ratio Trend",
        x_line2_title = paste(input$month, "Progression Ratio by TOD"),
        plot_title = "Progression Ratio")
})
})
```


### Queue Spillback Rate

```{r, fig.width = FIG_WIDTH, fig.height = FIG_HEIGHT, eval = TRUE, warning = FALSE}
rmarkdown::render_delayed({
renderPlotly({
    get_bar_line_dashboard_plot(mr()$wk$qs, mr()$mo$qsd, mr()$mo$mqsh,
                                "qs_freq", "percent", highlight_color = RED2,
                                month_ = current_month(), zone_group_ = zone_group(),
                                x_bar_title = paste(input$month, "Queue Spillback Rate"),
                                x_line1_title = "Queue Spillback Trend",
                                x_line2_title = paste(input$month, "Queue Spillback by TOD"),
                                plot_title = "Queue Spillback Rate")
})
})
```


### Peak Period Split Failures

```{r, fig.width = FIG_WIDTH, fig.height = FIG_HEIGHT, warning = FALSE}
rmarkdown::render_delayed({
renderPlotly({
    get_bar_line_dashboard_plot(
        mr()$wk$sf, 
        mr()$mo$sfd, 
        mr()$mo$sfh,
        "sf_freq", 
        "percent", 
        highlight_color = RED2,
        month_ = current_month(), 
        zone_group_ = zone_group(),
        x_bar_title = paste(input$month, "Split Failures Rate"),
        x_line1_title = "Peak Period Split Failures Trend",
        x_line2_title = paste(input$month, "Split Failures by TOD"),
        plot_title = "Peak Period Split Failures Rate")
})
})
```

### Off-Peak Split Failures

```{r, fig.width = FIG_WIDTH, fig.height = FIG_HEIGHT, warning = FALSE}
rmarkdown::render_delayed({
renderPlotly({
    get_bar_line_dashboard_plot(
        mr()$wk$sfo, 
        mr()$mo$sfo, 
        mr()$mo$sfh,
        "sf_freq", 
        "percent", 
        highlight_color = RED2,
        month_ = current_month(), 
        zone_group_ = zone_group(),
        x_bar_title = paste(input$month, "Off_Peak Split Failures Rate"),
        x_line1_title = "Off-Peak Split Failures Trend",
        x_line2_title = paste(input$month, "Split Failures by TOD"),
        plot_title = "Off-Peak Split Failures Rate")
})
})
```


### Travel Time Metrics

```{r, fig.width = FIG_WIDTH, fig.height = FIG_HEIGHT, eval = TRUE, warning = FALSE}
#rmarkdown::render_delayed({
renderPlotly({
    
    input_month <- input$month
    current_month_ <- current_month()
    zone_group_ <- zone_group() 
    
    future({
        get_tt_plot(cor$mo$tti, cor$mo$ttih, 
                    cor$mo$pti, cor$mo$ptih,
                    month_ = current_month_,
                    zone_group_ = zone_group_,
                    x_bar_title = paste(input_month, "TTI & PTI"),
                    x_line1_title = paste(input_month, "TTI by hr"),
                    x_line2_title = paste(input_month, "PTI by hr"))
    })
})
```









Volumes
=====================================

Row
-------------------------------------

### Traffic Volume [veh/day] {.value-box}

```{r, warning = FALSE}
renderValueBox({
  valueBox(
    value = get_valuebox(mr()$mo$vpd, "vpd", as_int,
                           zone = zone_group(), mo = current_month(), break_ = FALSE),
    icon = "fa-area-chart"
  )
})
```

### AM Peak Volume [veh/hr] {.value-box}

```{r, warning = FALSE}
renderValueBox({
  valueBox(
      value = get_valuebox(mr()$mo$vphp$am, "vph", as_int,
                           zone = zone_group(), mo = current_month(), break_ = FALSE),
      icon = "fa-area-chart"
  )
})
```

### PM Peak Volume [veh/hr] {.value-box}

```{r, warning = FALSE}
renderValueBox({
  valueBox(
      value = get_valuebox(mr()$mo$vphp$pm, "vph", as_int,
                           zone = zone_group(), mo = current_month(), break_ = FALSE),
      icon = "fa-area-chart"
  )
})
```

Row {.tabset .tabset-fade}
-------------------------------------

### Daily Volume

```{r, fig.width = FIG_WIDTH, fig.height = FIG_HEIGHT, eval = TRUE, warning = FALSE}
renderPlotly({ # Good version
    get_bar_line_dashboard_plot(mr()$wk$vpd, mr()$mo$vpd, NULL,
                                "vpd", "integer", highlight_color = GDOT_BLUE,
                                month_ = current_month(), zone_group_ = zone_group(),
                                x_bar_title = paste(input$month, "Daily Volume (vpd)"),
                                x_line1_title = "Vehicles per Day Trend",
                                plot_title = "Daily Volume (veh/day) Trend")
})
```

```{r, fig.width = FIG_WIDTH, fig.height = FIG_HEIGHT, eval = FALSE, warning = FALSE}
### Monthly Change
renderPlotly({
    get_pct_ch_plot(mr()$mo$vpd,
                    month_ = current_month(),
                    zone_group = zone_group())
})
```

```{r, fig.width = FIG_WIDTH, fig.height = FIG_HEIGHT, eval = FALSE, warning = FALSE}
### Peak Hour Volumes
renderPlotly({
    am_vph_plot <- get_bar_line_dashboard_plot(mr()$wk$vphp$am,
                                               mr()$mo$vphp$am, NULL,
                                "vph", "integer", highlight_color = GDOT_BLUE,
                                month_ = current_month(), zone_group_ = zone_group(),
                                x_bar_title = paste(input$month, "Hourly Volume (vph)"),
                                x_line1_title = "Vehicles per Hour Trend",
                                plot_title = "Peak Period Hourly Volume (veh/hr) Trend")
    pm_vph_plot <- get_bar_line_dashboard_plot(mr()$wk$vphp$pm,
                                               mr()$mo$vphp$pm, NULL,
                                "vph", "integer", highlight_color = GDOT_BLUE,
                                month_ = current_month(), zone_group_ = zone_group(),
                                x_bar_title = paste(input$month, "Hourly Volume (vph)"),
                                x_line1_title = "Vehicles per Hour",
                                plot_title = "Peak Period Hourly Volume (veh/hr) Trend")
    subplot(am_vph_plot, pm_vph_plot, nrows = 1, margin = 0.04)
})
```



```{r, fig.width = FIG_WIDTH, fig.height = FIG_HEIGHT, eval = FALSE, warning = FALSE}
### Hourly Volumes
renderPlotly({
    get_minmax_hourly_plot(mr()$mo$vph,
                           month_ = current_month(), 
                           zone_group_ = zone_group())
})
```


### Pedestrians

```{r, fig.width = FIG_WIDTH, fig.height = FIG_HEIGHT, eval = TRUE, warning = FALSE}
renderPlotly({ # Good version
    get_bar_line_dashboard_plot(mr()$wk$papd, mr()$mo$papd, NULL,
                                "papd", "integer", highlight_color = GDOT_BLUE,
                                month_ = current_month(), zone_group_ = zone_group(),
                                x_bar_title = paste(input$month, "Ped Activations (papd)"),
                                x_line1_title = "Ped Activations per Day Trend",
                                plot_title = "Pedestrian Activations per Day (pa/day)")
})
```








Equipment
=====================================

Row
-------------------------------------

### Vehicle Detector Availability {.value-box}

```{r, warning = FALSE}
renderValueBox({
  valueBox(
      value = get_valuebox(mr()$mo$du %>% 
                          group_by(Corridor) %>% 
                          mutate(delta = uptime - lag(uptime)), 
                      "uptime", as_pct,
                           zone = zone_group(), mo = current_month(), break_ = TRUE),
      icon = "fa-car"
  )
})
```

### CCTV Availability {.value-box}

```{r, warning = FALSE}
renderValueBox({
  valueBox(
    value = get_valuebox(mr()$mo$cctv, "uptime", as_pct,
                           zone = zone_group(), mo = current_month(), break_ = TRUE),
    icon = "glyphicon-facetime-video" 
  )
})
```

### Pedestrian Detector Availability {.value-box}

```{r, warning = FALSE}
renderValueBox({
  valueBox(
      value = get_valuebox(mr()$mo$pau, "uptime", as_pct,
                           zone = zone_group(), mo = current_month(), break_ = TRUE),
      icon = "fa-walking" 
  )
})
```




### Communications Uptime {.value-box}

```{r, warning = FALSE}
renderValueBox({
  valueBox(
      value = get_valuebox(mr()$mo$cu, "uptime", as_pct,
                           zone = zone_group(), mo = current_month(), break_ = TRUE),
      icon = "fa-broadcast-tower",
  )
})
```

### Roadside Unit (RSU) Uptime {.value-box}

```{r, warning = FALSE}
renderValueBox({
    valueBox(
        value = get_valuebox(
          mr()$mo$ru, 
          "uptime", 
          as_pct,
          zone = zone_group(), 
          mo = current_month(), 
          break_ = TRUE),
      icon = "fa-wifi"
    )
})
```

Row {.tabset .tabset-fade}
-------------------------------------

### Detector Uptime

```{r, fig.width = FIG_WIDTH, fig.height = FIG_HEIGHT, eval = TRUE, warning = FALSE}

renderPlotly({
    
    mr_dy_du <- mr()$dy$du
    mr_mo_du <- mr()$mo$du
    zone_group_ <- zone_group()
    current_month_ <- current_month()
    input_month <- input$month
    
    if (zone_group() == "All RTOP") {
        future({
        get_bar_line_dashboard_plot(
            cor$wk$du,
            cor$mo$du,
            var_ = "uptime",
            num_format = "percent",
            highlight_color = BLUE,
            month_ = current_month_, 
            zone_group_ = zone_group_,
            x_bar_title = paste(input_month, "Detector Uptime (%)"),
            x_line1_title = "Detector Uptime Trend",
            plot_title = "Detector Uptime")
        })
       
    } else if (corridor() == "All Corridors" || input$subcorridors == "By Sub-corridor") {

        future({
        get_cor_det_uptime_plot(
            mr_dy_du, 
            mr_mo_du,
            month_name = input_month,
            month_ = current_month_, 
            zone_group_ = zone_group_)
        })
    } else {
        
        get_uptime_plot(
            sig$dy$du, 
            sig$mo$du, 
            var_ = "uptime", 
            num_format = "percent", 
            month_ = current_month(), 
            zone_group_ = zone_group(),
            x_bar_title = "Current Month Uptime",
            x_line1_title = "Daily Uptime",
            plot_title = "",
            goal = NULL)
    }
})
```



### Pedestrian Detector Uptime


```{r, fig.width = FIG_WIDTH, fig.height = FIG_HEIGHT, eval = TRUE, warning = FALSE}

renderPlotly({

    mr_dy_pau <- mr()$dy$pau
    mr_mo_pau <- mr()$mo$pau
    zone_group_ <- zone_group()
    current_month_ <- current_month()
    input_month <- input$month
    
    if (zone_group() == "All RTOP") {
     
        future({
        get_bar_line_dashboard_plot(
            cor$wk$pau,
            cor$mo$pau,
            var_ = "uptime",
            num_format = "percent",
            highlight_color = BLUE,
            month_ = current_month_, 
            zone_group_ = zone_group_,
            x_bar_title = paste(input_month, "Ped Detector Uptime (%)"),
            x_line1_title = "Ped Detector Uptime Trend",
            plot_title = "Ped Detector Uptime")
        })
       
    } else if (corridor() == "All Corridors" || input$subcorridors == "By Sub-corridor") {
        
        future({
        get_cor_comm_uptime_plot(
            mr_dy_pau,
            mr_mo_pau,
            month_name = input_month,
            month_ = current_month_,
            zone_group_ = zone_group_)
        })
    } else {
        
      future({
      get_uptime_plot(
            sig$dy$pau, 
            sig$mo$pau, 
            var_ = "uptime", 
            num_format = "percent", 
            month_ = current_month_, 
            zone_group_ = zone_group_,
            x_bar_title = "Current Month Uptime",
            x_line1_title = "Daily Uptime",
            plot_title = "",
            goal = NULL)
      })
    }
})
```



```{r, fig.width = FIG_WIDTH, fig.height = FIG_HEIGHT, eval = FALSE, warning = FALSE}
### Pedestrian Detector Uptime
renderPlotly({
    
    weekly_ped_df <- rename(cor$mo$pau, Date = Month)
    monthly_ped_df <- cor$mo$pau
    get_bar_line_dashboard_plot(
        weekly_ped_df,
        monthly_ped_df,
        var_ = "uptime", 
        num_format = "percent", 
        highlight_color = BROWN,
        month_ = current_month(), 
        zone_group_ = zone_group(),
        x_bar_title = paste(input$month, "Ped Det Uptime"),
        x_line1_title = "Pedestrian Detector Uptime Trend",
        plot_title = "Ped Detector Uptime")
})
```

### CCTV Uptime

```{r, fig.width = FIG_WIDTH, fig.height = FIG_HEIGHT, warning = FALSE}

renderPlotly({
    
    zone_group_ <- zone_group()
    current_month_ <- current_month()
    input_month <- input$month
  
    if (corridor() == "All Corridors") {
        future({
        get_bar_line_dashboard_plot(cor$wk$cctv,
                                    cor$mo$cctv,
                                    var_ = "uptime",
                                    num_format = "percent",
                                    highlight_color = BROWN,
                                    month_ = current_month_, 
                                    zone_group_ = zone_group_,
                                    x_bar_title = paste(input_month, "CCTV Uptime"),
                                    x_line1_title = "CCTV Uptime Trend",
                                    plot_title = "CCTV Uptime")
        })
    } else {
        
        future({
        plot_individual_cctvs(sig$dy$cctv, 
                              month_ = current_month_, 
                              zone_group_ = zone_group_)
        })
    }
    
})
```




### Communications Uptime


```{r, fig.width = FIG_WIDTH, fig.height = FIG_HEIGHT, eval = TRUE, warning = FALSE}

renderPlotly({

    mr_dy_cu <- mr()$dy$cu
    mr_mo_cu <- mr()$mo$cu
                                 mr()$mo$cu
    zone_group_ <- zone_group()
    current_month_ <- current_month()
    input_month <- input$month
  
    if (zone_group() == "All RTOP") {
     
        future({
        get_bar_line_dashboard_plot(
            cor$wk$cu,
            cor$mo$cu,
            var_ = "uptime",
            num_format = "percent",
            highlight_color = BLUE,
            month_ = current_month_, 
            zone_group_ = zone_group_,
            x_bar_title = paste(input_month, "Comm Uptime (%)"),
            x_line1_title = "Comm Uptime Trend",
            plot_title = "Comm Uptime")
        })
       
    } else if (corridor() == "All Corridors" || input$subcorridors == "By Sub-corridor") {
        
        future({
        get_cor_comm_uptime_plot(mr_dy_cu,
                                 mr_mo_cu,
                                 month_name = input_month,
                                 month_ = current_month_,
                                 zone_group_ = zone_group_)
        })
    } else {
        
        future({
        get_uptime_plot(sig$dy$cu, 
                        sig$mo$cu, 
                        var_ = "uptime", 
                        num_format = "percent", 
                        month_ = current_month_, 
                        zone_group_ = zone_group_,
                        x_bar_title = "Current Month Uptime",
                        x_line1_title = "Daily Uptime",
                        plot_title = "",
                        goal = NULL)
        })
    }
})
```




### Roadside Unit (RSU) Uptime


```{r, fig.width = FIG_WIDTH, fig.height = FIG_HEIGHT, eval = TRUE, warning = FALSE}

renderPlotly({

    if (zone_group() == "All RTOP") {
     
        get_bar_line_dashboard_plot(
            cor$wk$ru,
            cor$mo$ru,
            var_ = "uptime",
            num_format = "percent",
            highlight_color = BLUE,
            month_ = current_month(), 
            zone_group_ = zone_group(),
            x_bar_title = paste(input$month, "RSU Uptime (%)"),
            x_line1_title = "RSU Uptime Trend",
            plot_title = "RSU Uptime")
       
    } else if (corridor() == "All Corridors" || input$subcorridors == "By Sub-corridor") {
        
        get_cor_comm_uptime_plot(
            mr()$dy$ru,
            mr()$mo$ru,
            month_name = input$month,
            month_ = current_month(),
            zone_group_ = zone_group())
    } else {
        
        get_uptime_plot(
            sig$dy$ru %>% filter(Date <= endof_last_month), 
            sig$mo$ru, 
            var_ = "uptime", 
            num_format = "percent", 
            month_ = current_month(), 
            zone_group_ = zone_group(),
            x_bar_title = "Current Month Uptime",
            x_line1_title = "Daily Uptime",
            plot_title = "",
            goal = NULL)
    }
    
})
```









Activity
=====================================

Row
-------------------------------------

### TEAMS Tasks Reported This Month {.value-box}

```{r, eval = TRUE, warning = TRUE}
renderValueBox({
  valueBox(
    value = get_valuebox(rename(cor$mo$tasks, delta = delta.rep), "Reported", as_int,
                           zone = zone_group(), mo = current_month(), break_ = FALSE),
    icon = "fa-area-chart"
  )
})
```

### TEAMS Tasks Resolved This Month {.value-box}

```{r, eval = TRUE, warning = TRUE}
renderValueBox({
  valueBox(
    value = get_valuebox(rename(cor$mo$tasks, delta = delta.res), "Resolved", as_int,
                           zone = zone_group(), mo = current_month(), break_ = FALSE),
    icon = "fa-area-chart"
  )
})
```

### TEAMS Tasks Outstanding (Unresolved) {.value-box}

```{r, eval = TRUE, warning = TRUE}
renderValueBox({
  valueBox(
    value = get_valuebox(rename(cor$mo$tasks, delta = delta.out), "Outstanding", as_int,
                           zone = zone_group(), mo = current_month(), break_ = FALSE),
    icon = "fa-area-chart"
  )
})
```

### TEAMS Tasks Over 45 Days [Unresolved] {.value-box}

```{r}
renderValueBox({
    valueBox(
        value = get_valuebox(
            mr()$mo$over45, 
            "over45", as_int, 
            zone = zone_group(), 
            mo = current_month(), 
            break_ = FALSE),
        icon = "fa-area-chart"
    )
})
```

### TEAMS Tasks Mean Time to Resolve [Days] {.value-box}

```{r}
renderValueBox({
    valueBox(
        value = get_valuebox(
            mr()$mo$mttr, 
            "mttr", as_2dec, 
            zone = zone_group(), 
            mo = current_month(), 
            break_ = FALSE),
        icon = "fa-area-chart"
    )
})
```

Row {.tabset .tabset-fade data-height=800}
------------------------------------------

### TEAMS

```{r TEAMS, warning = FALSE}

fillRow(
    fillCol(
        renderPlotly({ 
            data.set <- gather_outstanding_events(
                filter(mr()$mo$tasks, 
                       Zone_Group == zone_group(), 
                       Corridor == zone_group(),
                       Month <= current_month())
            )
            shiny::validate(need(nrow(data.set) > 0, "No Data"))
            cum_events_plot(data.set)
        }),
        renderPlotly({ 
            data.set <- filter(mr()$mo$ttyp, 
                               Zone_Group == zone_group(), 
                               Corridor == zone_group(),
                               Month == current_month(),
                               Reported > 0 | Resolved > 0 | Outstanding > 0)
            shiny::validate(need(nrow(data.set) > 0, "No Data"))
            plot_teams_tasks(data.set,
                             var_ = "Task_Type",
                             title_ = "Incidents This Month by Type (top), Source (bottom)", 
                             height_ = 250) 
        }), 
        renderPlotly({ 
            data.set <- filter(mr()$mo$tsou, 
                               Zone_Group == zone_group(), 
                               Corridor == zone_group(),
                               Month == current_month(),
                               Reported > 0 | Resolved > 0 | Outstanding > 0)
            shiny::validate(need(nrow(data.set) > 0, "No Data"))
            plot_teams_tasks(data.set,
                             var_ = "Task_Source", 
                             height_ = 150) 
        }), 
        height = 800, flex = c(NA, NA, 1)), 
        
    fillCol(
        renderPlotly({ 
            data.set <- filter(mr()$mo$tsub, 
                               Zone_Group == zone_group(), 
                               Corridor == zone_group(),
                               Month == current_month(),
                               Reported > 0 | Resolved > 0 | Outstanding > 0)
            shiny::validate(need(nrow(data.set) > 0, "No Data"))
            plot_teams_tasks(data.set,
                             var_ = "Task_Subtype",
                             title = "Incidents This Month by Subtype", 
                             textpos = "outside", 
                             height_ = 700) 
        }),
        height = 800))
```





### RTOP Activity Logs


#### **Download TSOS Monthly Reports (docx)**

`r lapply(rev(report_months[report_months >= '2018-01-01']), function(d) {
    Month_yyyy <- format(d, "%B %Y")
    yyyy_mm <- format(d, "%Y-%m")
    glue("[{Month_yyyy}](https://s3.amazonaws.com/gdot-spm/tsos_reports/TSOS+Monthly+Meeting+Report+-+{yyyy_mm}.docx)")
}) %>% paste(collapse = " | ")`


#### **Download Traffic Engineers' Activity Reports (pdf)**

```{r}
zone_links2 <- function(corrs_, current_month_, rtop_) {
    lapply(corrs_, function(corr) {
        yyyy <- format(current_month_, "%Y")
        mm <- format(current_month_, "%m")
        
        corr_plus <- paste(yyyy, mm, gsub("/", "-", corr))
        corr_plus <- gsub(" ", "+", corr_plus)
        glue("[{corr}]({AWS_BUCKET}/{rtop_}/{yyyy}-{mm}/{corr_plus}.pdf)")
    }) %>% paste(collapse = " | ")
}
zl <- reactive(zone_links2(c("SR 13/42/155", "SR 141S", "SR 237", "SR 9-Atlanta"), current_month(), "RTOP1"))
```

```{r Wrapper for Unused Code, eval = FALSE}

test_result_path <- file_temp("test_result_pdf", tmp_dir = "www", ext = ".pdf")
  
  output$test_results <- renderUI({
        test_result() %>%
          str_replace("https://s3.amazonaws.com", "s3:/") %>%
          get_object() %>%
          writeBin(test_result_path)
        tags$iframe(style = "height:1400px; width:100%", src = str_sub(test_result_path, 5))
 })
  
get_progress_report_link_by_zone("Zone 1", current_month(), "RTOP1"
```

**February 2019 and later**

`r renderUI({get_progress_report_link_by_zone("Zone 1", current_month(), "RTOP1")})` | 
`r renderUI({get_progress_report_link_by_zone("Zone 2", current_month(), "RTOP1")})` | 
`r renderUI({get_progress_report_link_by_zone("Zone 3", current_month(), "RTOP1")})` | 
`r renderUI({get_progress_report_link_by_zone("Zone 4", current_month(), "RTOP2")})` | 
`r renderUI({get_progress_report_link_by_zone("Zone 5", current_month(), "RTOP2")})` | 
`r renderUI({get_progress_report_link_by_zone("Zone 6", current_month(), "RTOP2")})` | 
`r renderUI({get_progress_report_link_by_zone("Zone 7", current_month(), "RTOP2")})` | 
`r renderUI({get_progress_report_link_by_zone("Zone 8", current_month(), "RTOP1")})`


### Zone Performance Summaries

```{r Summary Table, eval = TRUE}

corridor_summary_data <- reactive({ 
    get_corridor_summary_data(cor, current_month()) 
})
corridor_summary_table <- reactive({
    get_corridor_summary_table(corridor_summary_data(), input$zone_group)
})

tags$div(class = "corridor_summary_table",
    fillRow(
        renderFormattable({
            validate(need(corridor_summary_table(), 
                          "Select a Zone for the Metrics Summary Table"))
            corridor_summary_table()
        })
    )
)
fillRow(
    renderUI({
        req(corridor_summary_table())
        tags$div(
            p(strong("Legend:")), 
            p("Green text indicates a metric meeting the monthly goal; ",
              "red text indicates not meeting goal."),
            
            p(span(class = "glyphicon glyphicon-arrow-up", style = "color: green"),
              span(class = "glyphicon glyphicon-arrow-down", style = "color: green"),
              "A green arrow indicates an improvement from the previous month ",
              "(The arrow's direction indicates an increase or decrease in value); ",
              tags$br(),
              span(class = "glyphicon glyphicon-arrow-up", style = "color: red"),
              span(class = "glyphicon glyphicon-arrow-down", style = "color: red"),
              "A red up arrow indicates a deterioration from the previous month ",
              "(The arrow's direction indicates an increase or decrease in value); "))
    })
)
```

### Zone Activity Reports

```{r, echo=FALSE}

tinymce_api_key <- 'ee9qvzyyw4te05yjk9lxcmdephacz40a5qpni2kwh2cu74la'

tinyMCE <- function(inputId, content, options = NULL){
  tagList(
    singleton(tags$head(tags$script(src = glue("//cdn.tiny.cloud/1/{tinymce_api_key}/tinymce/5/tinymce.min.js")))),
    tags$div(id = inputId, class = "shinytinymce", content, style = "resize: none; width: 100%; height: 100%; border-style: none; background: gainsboro;"),
    tags$script(paste0('tinymce.init({selector:".shinytinymce", ', options, '});')),
    singleton(tags$head(tags$script(src = 'shinyMCE/shiny-tinymce-bindings.js')))
  )
}

editor_opts <- 
  'plugins: ["advlist autolink lists link image charmap print preview anchor",
             "searchreplace visualblocks code fullscreen",
             "insertdatetime media table contextmenu paste"],
   toolbar: "insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image"'    


shinyApp(
    
    ui = fluidPage(
        #a_zone_is_selected <- startsWith(zone_group(), "Zone"),
        #validate(a_zone_is_selected,
        #         "Select a Zone for Zone Manager comments for that Zone"),
        #req(startsWith(zone_group(), "Zone"))
        tags$head(tags$script(src = "message-handler.js")),

      conditionalPanel("input.zone_group == 'Zone 1'",

        
        fluidRow(
            column(width = 9,
                   hr(),
                   h3('Comments:'),
                   tinyMCE('editor1', 
                           verbatimTextOutput('zm_report1'),
                           editor_opts),
                   
                   hr(),
                   h4('First Box:'),
                   verbatimTextOutput('editor1_content'),
                   h4('Second Box:'),
                   verbatimTextOutput('editor2_content'),
                   
                   verbatimTextOutput('zone'),
                   verbatimTextOutput('month'),
                   tableOutput('zmdf_table')
            ),
            column(width = 3,
                   actionButton("undo_zm_comments", "Undo Comments"),
                   actionButton("save_zm_comments", "Save Comments"))
        )
      )
    ),

    server <- function(input, output, session) {
        
        rv <- reactiveValues(zmdf = zmdf0)
        
        output$zmdf_table <- renderTable({
            input$editor1
            rv$zmdf
        })
        
        output$editor1_content <- renderPrint({input$editor1})
        output$zone <- renderPrint({zone_group()})
        output$month <- renderPrint({current_month()})  # renderPrint({input$m})
        
        output$zm_report1 <- renderText({
            filter(rv$zmdf, Zone==zone_group(), Month==current_month())$Comments
        })

        observe({
            isolate({
                z <- zone_group()
                m <- current_month()
            })
            rv$zmdf[rv$zmdf$Zone==z & rv$zmdf$Month==m, "Comments"] <- input$editor1
        })
        
        observe({
            zone_group()
            current_month()
            isolate({
                updateTinyMCE(
                    session, 
                    'editor1', 
                    rv$zmdf[rv$zmdf$Zone==zone_group() & rv$zmdf$Month==current_month(), "Comments"]$Comments
                )
            })
        })
        
        observeEvent(input$undo_zm_comments, {
            showModal(modalDialog(
                title = "Undo comments?",
                tagList(
                    actionButton("confirmUndo", "Undo"),
                    modalButton("Cancel")
                )
            ))
        })
        observeEvent(input$confirmUndo, {
            rv$zmdf <- aws.s3::s3readRDS(bucket = "gdot-spm", object = "Zone_Manager_Report_Content.rds")
            removeModal()
        })

        observeEvent(input$save_zm_comments, {
            showModal(modalDialog(
                title = "Save comments?",
                tagList(
                    actionButton("confirmSave", "Save"),
                    modalButton("Cancel")
                )
            ))
        })
        observeEvent(input$confirmSave, {
            aws.s3::s3saveRDS(rv$zmdf, bucket = "gdot-spm", object = "Zone_Manager_Report_Content.rds")
            removeModal()
        })

},

  options = list(height = 800)
)
```


```{r, eval=FALSE}
# Coming soon.

renderUI({
    get_zg_monthly_report(input$current_month, input$zone_group)
})
```




Watchdog
=====================================

Row {data-height = 92}
-------------------------------------

```{r watchdog, fig.height = 0.92}

plot_height <- reactive({
    #n <- length(levels(filtered_alerts()$plot$signal_phase))
    n <- filtered_alerts()$intersections
    css_px <- as.character(50 + n * 14)
    paste0(css_px, "px")
})

filtered_alerts <- reactive({

    alerts_by_date <- filter_alerts_by_date(alerts, input$date_range)
    
    phase_ <- if(input$phase.eight != "All") {
        input$phase.eight
    } else {
        "All"
    }

    filter_alerts(alerts_by_date,
                  input$alert_type,
                  zone_group(),
                  corridor(),
                  phase_,
                  input$id_filter)
})
    


output$alerts_plot <- renderPlot({

    dataset <- filtered_alerts()

    if (nrow(dataset$plot) > 0) {
        
        plot_df <- dataset$plot %>% 
            mutate(signal_phase = factor(signal_phase))
        
        if (nrow(plot_df) > 0) {
            plot_alerts(plot_df, input$date_range)
        } else {
            plot_empty(zone_group)
        }

    } else {
        plot_empty(zone_group)
    }
})


# Main panel with tabs: Map, Table, Plots
fluidRow(
    column(
        width = 3,
        dateRangeInput(
            "date_range", "Date Range:",
            start = today() - days(14),
            end = today(),
            min = today() - days(365),
            max = today(),
            format = "mm/dd/yy", 
            startview = "month", 
            weekstart = 0,
            separator = " - ")
    ),
    column(
        width = 3,
        selectInput(
            "alert_type", "Alert:",
            choices = c("No Camera Image",
                        "Bad Vehicle Detection",
                        "Bad Ped Detection",
                        "Pedestrian Activations",
                        "Force Offs",
                        "Max Outs",
                        "Count",
                        "Missing Records"),
            selected = "No Camera Image")
    ),
    column(
        width = 2,
        conditionalPanel(
            "(input.alert_type == 'Missing Records') ||
             (input.alert_type == 'No Camera Image')",
            selectInput("phase.all", "Phase:",
                        choices = "All",
                        selected = "All")),
        conditionalPanel(
            "(input.alert_type == 'Pedestrian Activations') || 
            (input.alert_type == 'Force Offs') ||
            (input.alert_type == 'Max Outs') ||
            (input.alert_type == 'Count') ||
            (input.alert_type == 'Bad Vehicle Detection') ||
            (input.alert_type == 'Bad Ped Detection')",
            selectInput("phase.eight", "Phase:",
                        choices = c("All", seq_len(8)),
                        selected = "All"))
    ),
    column(
        width = 4,
        textInput("id_filter", "Intersection Filter:")
    )
)
```

Row {data-height = 800}
-------------------------------------

```{r}
fillRow(
    tabsetPanel(
        type = "tabs",
        tabPanel(
            "Plot", 
            helpText(
                div(class = "heatmap-explanation", 
                    paste("Darker colors mean more consecutive days", "
                          in which the alert condition is active.")),
                paste("Use the 'Intersection Filter' box to reduce the size of the list.",
                      "Filter on the intersection name or ID number.")
            ),
            renderUI({
              
                shiny::validate(
                    need(filtered_alerts()$intersections < 2000, 
                         paste("\n\n\nTOO MUCH DATA TO PLOT.",
                               "Select a Zone, Corridor of Phase", 
                               "to reduce the number of records.")))
                
                plotOutput("alerts_plot",
                           height = plot_height())
            })
        ),
        tabPanel(
            "Table", 
            renderDataTable({
                datatable(filtered_alerts()$table, 
                          escape = FALSE,
                          extensions = 'Scroller', 
                          options = list(
                              deferRender = TRUE,
                              scrollY = 500,
                              scroller = TRUE,
                              searching = FALSE))
            }),
            downloadHandler('watchdog_alerts.csv', content = function(file) {
                write_csv(filtered_alerts()$table, file)
            })
        )
    )
)
```







Signals List
=====================================

Row {data-height = 800}
-------------------------------------

```{r}
renderDataTable({
    
    datatable(filter(filtered_corridors(), as.integer(as.character(SignalID)) > 0),
              escape = FALSE,
              extensions = 'Scroller', 
              options = list(
                  deferRender = TRUE,
                  scrollY = 800,
                  scroller = TRUE,
                  searching = TRUE)
    )
})
```








```{r Map, echo = FALSE, eval = FALSE, fig.height = 9}
#Map
#=====================================

#map_data <- s3readRDS(bucket = "gdot-spm", object = "map_data.rds")

renderLeaflet({

    line_popups <- function(num, name, corr, tmc) {
        paste(sep = "<br/>", 
              glue("<b>Corridor: {corr}</b>"), 
              glue("<b>Route Number:</b> {num}"),
              glue("<b>Road Name:</b> {name}"),
              glue("<b>TMC Code:</b> {tmc}"))
    }
    
    point_popups <- function(description, zone, corridor) {
          paste(sep = "<br/>", 
              glue("<b>Signal: {description}</b>"), 
              glue("<b>Zone:</b> {zone}"),
              glue("<b>Corridor:</b> {corridor}"))
    }
    
    line_labels <- function(corridor) {
        glue("Corridor: {corridor}")
    }

    map <- leaflet() %>% 
    setView(
        lat = 33.7995454, 
        lng = -84.3729367, 
        zoom = 12) %>%
    addProviderTiles(providers$CartoDB.Positron) %>% 
    addPolylines(
        data = map_data$tmc_sp, 
        color = ~color,  # "steelblue",
        popup = ~line_popups(roadNumber, roadName, Corridor, tmc),
        label = ~line_labels(Corridor)) %>%  # line_labels(roadNumber, roadName, Corridor, tmc)) 
    addCircleMarkers(
        data = map_data$signals_sp,
        lng = ~Longitude,
        lat = ~Latitude,
        popup = ~point_popups(Description, Zone, Corridor),
        label = ~Description,  # point_labels(Description, Zone, Corridor),
        radius = 3,
        fillColor = ~fill_color,
        color = ~stroke_color,
        stroke = TRUE,
        fillOpacity = 1,
        opacity = 1,
        weight = 1)

})
```







Signal Details
=====================================

```{r signal_detail, eval = TRUE}
fillCol(height = 100,
    
    fluidRow(
        column(width = 4,
        renderUI(selectInput("signalid", "Select Signal:",
                    choices = c("Select", filtered_signalids()),
                    selected = "",
                    width = "800px"))),
        column(width = 1,
        tags$div(class = "plot-signal-details-button",
                 actionButton("signal_details_button", "Plot")))
    )
)

sid <- eventReactive(input$signal_details_button, {
    req(input$signalid)
    sub(":.+", "", input$signalid)
})


fillCol(height = 700,

        renderPlotly({
            #signal_dashboard_athena(sid(), current_month(), conf$athena)
            detector_dashboard_athena(sid(), current_month(), conf$athena)
        })
)
```










About
=====================================

### PERFORMANCE

#### **Throughput**

Throughput is a measure of efficiency. It is meant to represent the maximum
number of vehicles serviced through an intersection, and the corridor.

Throughput is calculated as the highest 15-minute volume in a day for
each intersection, converted to an hourly volume, averaged over the
corridor. Volumes come from high-resolution event logs from the controller,
which are stored in the ATSPM database.

#### **Arrivals on Green**

Arrivals on Green (AOG) is a measure of coordination. A percentage of 
vehicles arriving on green would be due to good offsets
and should be correlated with fewer stops and less delay.

AOG is calculated as the total number of vehicles arriving on green
divided by the total number of arrivals. It includes main street through phases,
during peak periods (6am-10am, 3pm-7pm) on Tuesdays, Wednesdays and
Thursdays.

The calculation takes the ATSPM data, aggregates the counts by cycle and
interval, and divides the counts in the green intervals by the total counts
for the cycle, averaged over all cycles.

#### **Progression Ratio**

Progression Ratio is arrivals on green (AOG) percentage divided by the percent green
for that phase. A ratio of greater than 1 means better than random arrivals.

#### **Queue Spillback Rate**

Queue Spillback Rate is an experimental measure of effectiveness.
It is a measure of unmet demand in a cycle. Based on the vehicle
dwell times over setback detectors on the main street through phases, 
each cycle is evaluated for spillback. A spillback condition will be triggered by
occupancy readings above what is typical for setback detectors under
freely flowing conditions. 

Specifically, under freely flowing
conditions, the time between subsequent detector on and off events is typically
around 0.1 seconds for setback detectors. 
When the 95^th^ percentile detector occupancy duration increases above 3
seconds in a cycle, it will be assumed there is standing traffic on the setback
detector and a spillback event will be flagged for that phase in that
cycle.

The queue spillback rate is calculated as the number of spillback events
divided by the number of cycles for main street through phases.

#### **Split Failures**

Split failure is another measure of unmet demand. It identifies cycles 
where a phase has unserved demand. A phase is flagged for split failure when 
the average occupancy of the stop bar detectors on the phase are greater than 80%
during the green phase and greater than 80% during the first five seconds of the
red phase. The intersection is flagged as a split failure on that cycle if 
at least one phase meets the criteria for split failure during that phase.

Because this measure requires stop bar detection, it is only be calculated 
for side street and left turn phases, i.e., all phases other than 
main street through phases.

#### **Travel Time Index**

Travel Time Index (TTI) is a measure of delay on the corridor. It is the
ratio of travel time to free flow travel time.

Hourly travel time data from HERE queried from RITIS. Free flow travel
times are based on the "reference speed" value from HERE for each
segment. Travel time and free flow travel time are calculated for each
corridor by summing over all segments in the corridor for every hour in
the month.

An hourly Travel Time Index is then calculated for each corridor as the
average travel time for that hour of the day divided by the free flow
travel time for the corridor. The TTI for each hour is then averaged
over the day, weighted by the average hourly volume on the main street 
through phases (from ATSPM) to get a TTI for the month (this gives more 
weight to peak periods than off-peak periods). 

#### **Planning Time Index**

The Planning Time Index (PTI) calculation uses the same data as the
Travel Time Index. However, instead of taking the average travel times
for each hour of the day, it takes the 90^th^ percentile for each hour,
over the days of the month. These 90^th^ percentile travel times are
then averaged over the day, weighted by the average hourly volume from
the main street through phases  (from ATSPM) to get a PTI for the month 
(this gives more weight to peak periods than off-peak periods).



### VOLUMES

#### **Daily Volume**

Volume is a measure of demand on a corridor. Total volume on main street 
through phases are summed over each Tuesday, Wednesday and Thursday,
and then averaged over all days in the month.

#### **Monthly Change**

Each bar in the Monthly Change plot shows the percent change in daily volume
compared with the previous month.

#### **Peak Hour Volumes**

The AM and PM average peak hour volumes are the average hourly volume
for the month over the AM and PM peak hours, respectively. 
Peak hours are 6am-10am, 3pm-7pm.

#### **Hourly Volumes**

The hourly volumes chart shows the range of hourly volumes for all
months from the beginning of the data set, superimposed with the hourly
volumes for the current month. It is meant to show the spread of each
hour and whether the current month is high or low compared to the
historical range.

### EQUIPMENT AND ACTIVITY

#### **Detector Uptime**

Detector Uptime is a measure of state-of-good-repair, which may be correlated to
other performance measures since failed detectors may negatively affect
performance.

Based on hourly volumes by detector, each hour is flagged if any of the
following conditions apply:

-   Missing data (volume = NA)

-   volume &gt; 1000

-   Absolute change in volume from previous hour &gt; 500

-   change in volume from previous hour = 0

For each day, if more than 40% of hours are flagged the detector is considered down for that day.
Separately, if the average absolute change from the previous hour, averaged over the day, is
greater than 200, the detector is considered down fot that day. The
uptime is the percentage of good days in the month. These thresholds are
all based on observation of the data and can be adjusted as necessary.

#### **Pedestrian Detector Uptime**

Pedestrian Detector Uptime is the percentage of pedestrian inputs operational. 
It is based on the historical distribution of the daily number of pedestrian actuations.
Currently, when the number of consecutive days without an input yields a probability
of failure based on the historical distribution for that input, it is flagged as failed.
This measure is still experimental and the distributions and thresholds are a work in progress.

In the past, this measure was based on manual testing of pedestrian push buttons and
was self-reported by the engineers responsible for the corridor. While labor-intensive,
This had some benefits over the current automated approach. The first is that
multiple push buttons are often physically wired into the same detector input,
making it impossible from the controller inputs to determine whether both push
buttons are working, or just one. The second is due to the relatively infrequent calls,
we have to rely upon a probabalistic approach to determining whether an input is failed
because for some push buttons, there is so little demand it can be difficult to say with
certainty from the data whether that the push button is indeed failed.

#### **CCTV Uptime**

Through December 2017, CCTV Uptime was reported by Corridor Managers in their 
monthly reports. In January, 2018, it came from TSOS based on a manual check
of each camera during the month and reporting whether it returns an
image and whether it can be controlled (pan-tilt-zoom).

As of February 2018, CCTV Uptime is calculated based on the image returned from
the Georgia 511 website. If there is a live image, it will considered
working as of its "last modified" timestamp from the website.

#### **Communications Uptime**

This is calculated from gaps in the ATSPM high resolution data. Any gaps
in subsequent events greater than 15 minutes are considered to be due to 
communication loss. The sum of these gaps converted to a percent is the
daily communication uptime for that controller. If comms are lost for all
intersections, it is considered a system failure and that time is excluded
from the uptime calculation.

#### **Events Reported, Resolved, Outstanding**

Activity measures come from TEAMS reports from data as entered by corridor managers.
TEAMS is GDOT's ticketing and tracking system for signal equipment and 
incident-related activity.

All events reported in the month are counted, as are the number of
events resolved in the month. The number of outstanding events is the
cumulative sum of reported events less the cumulative sum of resolved
events.

#### **RTOP Activity Logs**

These are the monthly reports produced monthly by RTOP Corridor Managers 
detailing key activities, maintenance tasks and action items for the month.
